{% extends "base_step.html" %}

{% block content %}
{% set scores = clip.scores or {} %}
{% set score_tabs = [
    {'key': 'overall', 'label': 'Overall'},
    {'key': 'hook', 'label': 'Hook'},
    {'key': 'clarity_self_contained', 'label': 'Flow'},
    {'key': 'shareability', 'label': 'Engagement'},
    {'key': 'surprise_novelty', 'label': 'Trend'}
] %}
{% set is_preview = request.query_params.get('mode') == 'preview' %}

<style>
    #transcript-list.transcript-only .chunk-range {
        display: none;
    }

    #transcript-list.transcript-only .chunk-text {
        font-size: 1rem;
    }

    .score-tab {
        padding: 0.375rem 0.75rem;
        border-radius: 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: rgba(209, 213, 219, 1);
        transition: all 0.2s ease;
        background: transparent;
    }

    .score-tab:hover {
        border-color: rgba(255, 255, 255, 0.4);
        color: #fff;
    }

    .score-tab.active {
        background: #fff;
        color: #000;
        border-color: #fff;
        font-size: 0.6875rem;
    }
</style>

<div id="clip-page" data-is-preview="{{ 'true' if is_preview else 'false' }}" class="w-full max-w-6xl mx-auto min-h-[calc(100vh-140px)] flex flex-col px-4 py-6 lg:px-6 lg:py-8 gap-6 overflow-y-auto">

    <!-- Header -->
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-4 shrink-0">
        <div class="flex items-center gap-4 w-full lg:w-auto">
            <a href="/app/jobs/{{ job.id }}/clips" id="back-btn"
                class="text-gray-400 hover:text-white transition p-2 hover:bg-white/10 rounded-lg inline-flex items-center">
                <i class="fa-solid fa-arrow-left"></i>
            </a>
            <div>
                <p class="text-[11px] text-gray-500 uppercase tracking-widest">Clip #{{ clip.index or 1 }}</p>
                <h1 class="text-lg lg:text-2xl font-bold text-white truncate flex-1">
                    {{ clip.title or 'Untitled Clip' }}
                </h1>
            </div>
        </div>
        <div class="flex flex-row flex-wrap items-center gap-3 w-full lg:w-auto justify-end relative">

            <button id="delete-clip-btn"
                class="bg-red-500/20 border border-red-500/30 text-red-400 text-[11px] lg:text-xs font-bold px-3 py-2 rounded-lg hover:bg-red-500/30 transition flex items-center gap-2 whitespace-nowrap">
                <i class="fa-solid fa-trash"></i> <span class="hidden sm:inline">Delete</span>
            </button>
            <button
                class="bg-[#1a1a1a] border border-white/10 text-white text-[11px] lg:text-xs font-bold px-3 py-2 rounded-lg hover:bg-white/10 transition whitespace-nowrap">
                Remove watermark
            </button>
            {% if is_preview %}
            <button id="publish-btn"
                class="bg-[#1a1a1a] border border-white/10 text-white text-[11px] lg:text-xs font-bold px-3 py-2 rounded-lg hover:bg-white/10 transition flex items-center gap-2 whitespace-nowrap">
                <i class="fa-regular fa-calendar"></i>
                <span class="hidden sm:inline">Publish on Social</span>
                <span class="sm:hidden">Publish</span>
                <i class="fa-solid fa-chevron-down text-[9px]"></i>
            </button>

            <div id="publish-menu"
                class="hidden absolute right-0 top-full mt-2 w-52 rounded-xl border border-white/20 bg-[#0b0b0b] shadow-xl shadow-black/60 z-40 overflow-hidden">
                <a href="https://twitter.com/intent/tweet?url={{ request.url }}" target="_blank" rel="noopener noreferrer"
                    class="flex items-center gap-2 px-3 py-2.5 text-xs text-gray-100 hover:bg-white hover:text-black transition">
                    <i class="fa-brands fa-x-twitter w-4 text-sky-400"></i>
                    <span>X (Twitter)</span>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.url }}" target="_blank" rel="noopener noreferrer"
                    class="flex items-center gap-2 px-3 py-2.5 text-xs text-gray-100 hover:bg-white hover:text-black transition">
                    <i class="fa-brands fa-facebook w-4 text-blue-500"></i>
                    <span>Facebook</span>
                </a>
                <a href="https://www.instagram.com/" target="_blank" rel="noopener noreferrer"
                    class="flex items-center gap-2 px-3 py-2.5 text-xs text-gray-100 hover:bg-white hover:text-black transition">
                    <i class="fa-brands fa-instagram w-4 text-pink-400"></i>
                    <span>Instagram</span>
                </a>
                <a href="https://studio.youtube.com/" target="_blank" rel="noopener noreferrer"
                    class="flex items-center gap-2 px-3 py-2.5 text-xs text-gray-100 hover:bg-white hover:text-black transition">
                    <i class="fa-brands fa-youtube w-4 text-red-500"></i>
                    <span>YouTube Studio</span>
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    {% if not is_preview %}
    <div class="flex flex-col gap-6 flex-1">

        <!-- Scene analysis + transcript (Req 9) -->
        <section class="bg-[#111] border border-white/10 rounded-2xl flex-1 flex flex-col min-h-0">
            <div class="p-5 flex flex-col gap-4 border-b border-white/5">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <p class="text-[11px] text-sky-300 uppercase tracking-widest">Scene analysis</p>
                        <h3 class="text-xl font-bold text-white">Transcript & timing</h3>
                    </div>
                    <div class="flex items-center gap-3 ml-auto">
                        <label class="flex items-center gap-2 cursor-pointer text-[11px] text-gray-400">
                            <input type="checkbox" id="transcript-only-toggle"
                                class="w-3.5 h-3.5 rounded bg-[#1a1a1a] border-gray-600 text-green-500 focus:ring-0">
                            Transcript only
                        </label>
                        <a href="?mode=preview"
                            class="bg-white text-black text-[11px] lg:text-xs font-bold px-4 py-2 rounded-lg hover:bg-gray-200 transition flex items-center gap-2">
                            <i class="fa-solid fa-play"></i>
                            View clip preview
                        </a>
                    </div>
                </div>
                <p class="text-sm text-gray-300 leading-relaxed">{{ clip.description or clip.why or "No summary available." }}</p>
            </div>
            <!-- Hidden audio element so transcript chunks can play sound on transcript view -->
            <audio id="main-video" class="hidden"></audio>
            <div id="transcript-list" class="flex-1 overflow-y-auto p-5 space-y-2"></div>
        </section>
    </div>
    {% else %}
    <!-- Req 10 full preview view -->
    <div class="flex flex-col gap-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Video preview -->
            <section class="lg:w-5/12 flex flex-col gap-4">
                <div class="bg-gradient-to-b from-[#1b1b1b] to-[#0f0f0f] border border-white/10 rounded-2xl p-5 flex flex-col gap-5 shadow-inner">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <p class="text-[11px] text-gray-500 uppercase tracking-widest">Clip preview</p>
                            <p class="text-sm text-gray-400">{{ clip.category or 'Auto-selected highlight' }}</p>
                        </div>
                        <div id="preview-status" class="hidden text-[10px] font-semibold px-2 py-1 rounded-full bg-green-500/10 text-green-300 border border-green-500/40 self-start">
                            Preview ready
                        </div>
                    </div>

                    <div class="relative w-full bg-black/70 rounded-2xl overflow-hidden shadow-lg" style="aspect-ratio: 9 / 16;">
                        <video id="main-video" class="absolute inset-0 w-full h-full object-cover" playsinline controls poster="{{ clip.thumbnail_url or clip.thumbnail or '' }}"></video>
                        <div id="video-placeholder"
                            class="absolute inset-0 flex flex-col items-center justify-center gap-2 text-gray-400 text-sm bg-black/70">
                            <i class="fa-solid fa-spinner fa-spin text-lg"></i>
                            <span>Generating preview…</span>
                            <small class="text-[11px] text-gray-500 text-center">You can still interact with the transcript and scoring while the preview loads.</small>
                        </div>
                        <div class="absolute top-3 left-3 bg-black/70 px-2 py-1 rounded text-[11px] font-mono text-white">
                            <span id="current-time">00:00</span> / <span id="total-time">00:00</span>
                        </div>
                        <div class="absolute top-3 right-3 bg-black/70 px-2 py-1 rounded text-[10px] text-black uppercase">
                            {{ clip.aspect or "9:16" }}
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                        <select id="format-selector"
                            class="bg-[#1a1a1a] border border-white/10 text-black text-xs font-bold px-3 py-2 rounded-lg hover:bg-white/10 transition">
                            <option value="9:16">9:16 (Vertical)</option>
                            <option value="16:9">16:9 (Horizontal)</option>
                            <option value="1:1">1:1 (Square)</option>
                        </select>
                        <button id="download-btn"
                            class="bg-purple-500 border border-purple-500/30 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-purple-600 transition flex items-center gap-2 whitespace-nowrap">
                            <i class="fa-solid fa-download"></i>
                            <span class="hidden sm:inline">Download HD</span>
                            <span class="sm:hidden">Download</span>
                        </button>
                        <a href="?" class="text-gray-400 hover:text-white text-xs font-semibold flex items-center gap-2">
                            <i class="fa-solid fa-list"></i>
                            Transcript view
                        </a>
                    </div>
                </div>
            </section>

            <!-- Score + summary card -->
            <section class="flex-1 flex flex-col gap-4">
                <div class="bg-[#111] border border-white/10 rounded-2xl p-5 flex flex-col gap-5">
                    <div class="flex flex-col gap-2">
                        <p class="text-xs uppercase tracking-[0.3em] text-gray-500">#{{ clip.index or 1 }}</p>
                        <h2 class="text-2xl font-bold text-white leading-tight">{{ clip.title or 'Untitled Clip' }}</h2>
                    </div>
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div>
                            <p class="text-[11px] text-gray-500 uppercase tracking-widest">Score</p>
                            <div class="flex items-baseline gap-2">
                                <span id="active-score" class="text-4xl font-black text-white">{{ clip.overall | default(0) }}</span>
                                <span class="text-sm text-gray-500">/100</span>
                            </div>
                            <p id="active-score-label" class="text-[11px] text-gray-400 uppercase tracking-widest mt-1">Overall</p>
                        </div>
                        <div class="flex flex-wrap gap-2" role="tablist" aria-label="Score breakdown">
                            {% for tab in score_tabs %}
                            {% set tab_value = clip.overall if tab.key == 'overall' else scores[tab.key] | default('-') %}
                            <button type="button" class="score-tab {% if tab.key == 'overall' %}active{% endif %}" data-score-key="{{ tab.key }}"
                                data-score-label="{{ tab.label }}" data-score-value="{{ tab_value }}">
                                {{ tab.label }}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <p class="text-[11px] text-sky-300 uppercase tracking-widest">Reason selected</p>
                            <p class="text-sm text-gray-300 leading-relaxed">{{ clip.why or clip.description or "No summary available." }}</p>
                        </div>
                        <div>
                            <p class="text-[11px] text-gray-500 uppercase tracking-widest">Duration</p>
                            <p class="text-lg font-semibold text-white">{{ (clip.end - clip.start) | default(0) | round(2) }}s</p>
                        </div>
                        <div>
                            <p class="text-[11px] text-gray-500 uppercase tracking-widest">Summary</p>
                            <div class="bg-white/5 border border-white/10 rounded-xl p-4 text-sm text-gray-300 leading-relaxed max-h-48 overflow-y-auto">
                                {{ clip.summary or clip.description or clip.why or "Summary not available." }}
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button id="select-clip-btn"
                            class="bg-white text-black font-bold text-sm px-6 py-2.5 rounded-lg hover:bg-gray-200 transition shadow-lg shadow-white/5"
                            data-selected="false">
                            Select Clip
                        </button>
                    </div>
                </div>
            </section>
        </div>

        <section class="bg-[#111] border border-white/10 rounded-2xl flex-1 flex flex-col min-h-0">
            <div class="p-5 flex flex-col gap-4 border-b border-white/5">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    <div>
                        <p class="text-[11px] text-gray-500 uppercase tracking-widest">Transcript</p>
                        <h3 class="text-xl font-bold text-white">Line-by-line timing</h3>
                    </div>
                    <label class="flex items-center gap-2 cursor-pointer text-[11px] text-gray-400 ml-auto">
                        <input type="checkbox" id="transcript-only-toggle"
                            class="w-3.5 h-3.5 rounded bg-[#1a1a1a] border-gray-600 text-green-500 focus:ring-0">
                        Transcript only
                    </label>
                </div>
                <p class="text-sm text-gray-300 leading-relaxed">Click any line to seek the video preview.</p>
            </div>
            <div id="transcript-list" class="flex-1 overflow-y-auto p-5 space-y-2"></div>
        </section>
    </div>
    {% endif %}

</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center">
    <div class="bg-black border border-white/20 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl shadow-black/80">
        <h3 class="text-white text-lg font-bold mb-4">Delete Clip?</h3>
        <p class="text-gray-400 text-sm mb-6">Are you sure you want to delete this clip? This action cannot be undone.</p>
        <div class="flex gap-3">
            <button id="cancel-delete-btn"
                class="flex-1 bg-white/10 text-white font-bold py-2 rounded-lg hover:bg-white/20 transition">
                Cancel
            </button>
            <button id="confirm-delete-btn"
                class="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg hover:bg-red-600 transition">
                Delete
            </button>
        </div>
    </div>
</div>

<script type="application/json" id="clip-data">
    {{ clip | tojson | safe }}
</script>

<script>
    const jobId = "{{ job.id }}";
    const clipId = "{{ clip.id }}";

    const clipDataEl = document.getElementById('clip-data');
    const clipData = clipDataEl ? JSON.parse(clipDataEl.textContent || '{}') : {};
    const clipStart = Number(clipData.start || 0);
    const clipEnd = Number(clipData.end || 0);
    const transcriptSegments = Array.isArray(clipData.transcript_segments) ? clipData.transcript_segments : [];

    const pageEl = document.getElementById('clip-page');
    const isPreview = pageEl?.dataset?.isPreview === 'true';

    const mainVideo = document.getElementById('main-video');
    const videoPlaceholder = document.getElementById('video-placeholder');
    const previewStatus = document.getElementById('preview-status');

    const transcriptList = document.getElementById('transcript-list');
    const downloadBtn = document.getElementById('download-btn');
    const deleteClipBtn = document.getElementById('delete-clip-btn');
    const formatSelector = document.getElementById('format-selector');
    const transcriptToggle = document.getElementById('transcript-only-toggle');
    const publishBtn = document.getElementById('publish-btn');
    const publishMenu = document.getElementById('publish-menu');
    const selectClipBtn = document.getElementById('select-clip-btn');

    const deleteModal = document.getElementById('delete-modal');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

    const scoreTabs = document.querySelectorAll('.score-tab');
    const activeScoreEl = document.getElementById('active-score');
    const activeScoreLabel = document.getElementById('active-score-label');

    // Restrict transcript lines to only those overlapping this clip and
    // convert their times to be relative to clipStart so they match the
    // clipped audio.
    const lines = Array.isArray(transcriptSegments)
        ? transcriptSegments
            .filter((seg) => {
                if (!seg) return false;
                const s = Number(seg.start ?? seg.begin ?? 0);
                const e = Number(seg.end ?? seg.stop ?? 0);
                return e > clipStart && s < clipEnd;
            })
            .map((seg) => {
                const absStart = Number(seg.start ?? seg.begin ?? 0);
                const absEnd = Number(seg.end ?? seg.stop ?? 0);
                const clampedStart = Math.max(absStart, clipStart);
                const clampedEnd = Math.min(absEnd, clipEnd);
                return {
                    ...seg,
                    start: clampedStart - clipStart,
                    end: clampedEnd - clipStart,
                };
            })
        : [];

    function renderTranscriptChunks() {
        if (!transcriptList) return;
        transcriptList.innerHTML = '';
        if (!lines.length) {
            transcriptList.innerHTML = '<div class="text-gray-500 text-sm text-center mt-10">No transcript available.</div>';
            return;
        }

        // Group segments into paragraphs
        const groups = [];
        let currentGroup = {
            start: lines[0].start,
            end: lines[0].end,
            text: lines[0].text,
            segments: [lines[0]]
        };

        for (let i = 1; i < lines.length; i++) {
            const s = lines[i];
            const prev = lines[i - 1];

            const timeGap = s.start - prev.end;
            const isSentenceEnd = /[.?!]$/.test(prev.text.trim());
            const groupDuration = prev.end - currentGroup.start;

            if (timeGap > 1.5 || (isSentenceEnd && groupDuration > 5) || groupDuration > 15) {
                groups.push(currentGroup);
                currentGroup = {
                    start: s.start,
                    end: s.end,
                    text: s.text,
                    segments: [s]
                };
            } else {
                currentGroup.end = s.end;
                currentGroup.text += " " + s.text;
                currentGroup.segments.push(s);
            }
        }
        groups.push(currentGroup);

        groups.forEach(g => {
            const row = document.createElement("div");
            row.className = "group cursor-pointer hover:bg-white/5 p-2 rounded-lg transition mb-1";

            const range = `[${formatDuration(g.start)} - ${formatDuration(g.end)}]`;

            row.innerHTML = `
                    <div class="chunk-range text-[10px] text-gray-500 font-mono mb-1 group-hover:text-gray-400 transition">${range}</div>
                    <div class="flex gap-3">
                        <div class="shrink-0 mt-0.5">
                            <i class="fa-regular fa-closed-captioning text-gray-600 text-xs group-hover:text-white transition"></i>
                        </div>
                        <p class="chunk-text text-sm text-gray-300 leading-relaxed group-hover:text-white transition font-medium">
                            ${g.text}
                        </p>
                    </div>
                `;

            row.addEventListener("click", () => {
                if (mainVideo) {
                    const seekTime = Math.max(0, g.start || 0);
                    mainVideo.currentTime = seekTime;
                    mainVideo.play().catch(() => { });
                }
            });

            transcriptList.appendChild(row);
        });
    }

    async function loadPreview(aspectOverride) {
        if (!mainVideo) return;
        try {
            // Reset placeholder when (re)loading preview
            if (videoPlaceholder) {
                videoPlaceholder.classList.remove("hidden");
                videoPlaceholder.style.display = "flex";
            }

            const form = new FormData();
            form.append("job_id", jobId);
            form.append("clip_id", clipId);
            const aspect = aspectOverride || (formatSelector ? formatSelector.value : "9:16");
            form.append("aspect", aspect);
            const res = await fetch("/export/preview", { method: "POST", body: form });

            if (res.ok) {
                const data = await res.json();

                // If we reused an existing preview, clarify that we're just loading it
                if (videoPlaceholder && data.from_cache) {
                    const msgSpan = videoPlaceholder.querySelector('span');
                    if (msgSpan) msgSpan.textContent = 'Loading preview…';
                }

                mainVideo.src = data.preview_url;

                // Update preview status pill
                if (previewStatus) {
                    previewStatus.classList.remove('hidden');
                    previewStatus.textContent = data.from_cache ? 'Preview loaded' : 'Preview ready';
                }

                mainVideo.onloadedmetadata = () => {
                    const duration = formatTime(mainVideo.duration);
                    const totalEl = document.getElementById('total-time');
                    if (totalEl) totalEl.textContent = duration;
                };
                mainVideo.addEventListener('timeupdate', () => {
                    const currentEl = document.getElementById('current-time');
                    if (currentEl) currentEl.textContent = formatTime(mainVideo.currentTime);
                });
                if (videoPlaceholder) {
                    videoPlaceholder.classList.add("hidden");
                    videoPlaceholder.style.display = 'none';
                }
            } else {
                if (videoPlaceholder) videoPlaceholder.textContent = "Preview generation failed.";
            }
        } catch (e) {
            console.error(e);
            if (videoPlaceholder) videoPlaceholder.textContent = "Error loading preview.";
        }
    }

    function init() {
        renderTranscriptChunks();
        if (mainVideo) {
            loadPreview();
        }

        if (transcriptToggle) {
            transcriptToggle.addEventListener('change', (e) => {
                transcriptList.classList.toggle('transcript-only', e.target.checked);
            });
        }

        if (scoreTabs.length && activeScoreEl && activeScoreLabel) {
            scoreTabs.forEach((tab, idx) => {
                tab.addEventListener('click', () => {
                    scoreTabs.forEach(btn => btn.classList.remove('active'));
                    tab.classList.add('active');
                    activeScoreEl.textContent = tab.dataset.scoreValue || '-';
                    activeScoreLabel.textContent = tab.dataset.scoreLabel || '';
                });
                if (idx === 0) {
                    tab.click();
                }
            });
        }

        if (isPreview && formatSelector && mainVideo) {
            formatSelector.addEventListener("change", () => {
                // Reload preview with newly selected aspect
                loadPreview(formatSelector.value);
            });
        }

        if (publishBtn && publishMenu) {
            const togglePublishMenu = (e) => {
                if (e) {
                    e.stopPropagation();
                }
                publishMenu.classList.toggle('hidden');
            };

            publishBtn.addEventListener('click', togglePublishMenu);

            if (selectClipBtn) {
                selectClipBtn.addEventListener('click', () => {
                    // Toggle visual selected state only
                    const isSelected = selectClipBtn.getAttribute('data-selected') === 'true';
                    if (!isSelected) {
                        selectClipBtn.setAttribute('data-selected', 'true');
                        selectClipBtn.textContent = 'Selected';
                        selectClipBtn.classList.remove('bg-white', 'text-black');
                        selectClipBtn.classList.add('bg-green-500', 'text-white');
                    } else {
                        selectClipBtn.setAttribute('data-selected', 'false');
                        selectClipBtn.textContent = 'Select Clip';
                        selectClipBtn.classList.remove('bg-green-500', 'text-white');
                        selectClipBtn.classList.add('bg-white', 'text-black');
                    }
                });
            }

            document.addEventListener('click', (e) => {
                if (!publishMenu.classList.contains('hidden') && !publishMenu.contains(e.target) && e.target !== publishBtn && e.target !== selectClipBtn) {
                    publishMenu.classList.add('hidden');
                }
            });
        }
    }

    if (downloadBtn && formatSelector) {
        downloadBtn.addEventListener("click", async () => {
            const aspect = formatSelector.value;
            downloadBtn.disabled = true;

            downloadBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Preparing...`;
            try {
                const form = new FormData();
                form.append("job_id", jobId);
                form.append("clip_id", clipId);
                form.append("aspect", aspect);
                const res = await fetch("/export/clip/download", {
                    method: "POST",
                    body: form,
                });
                if (!res.ok) throw new Error("Download failed");
                const data = await res.json();
                if (data.download_url) {
                    // Force a real file download instead of opening the video in the browser
                    const link = document.createElement('a');
                    link.href = data.download_url;
                    link.download = '';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            } catch (e) {
                alert("Error downloading clip");
                console.error(e);
            } finally {
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = `<i class="fa-solid fa-download"></i> <span class="hidden sm:inline">Download HD</span><span class="sm:hidden">Download</span>`;
            }
        });
    }

    if (deleteClipBtn && deleteModal) {
        deleteClipBtn.addEventListener("click", () => {
            deleteModal.classList.remove('hidden');
        });
    }

    if (confirmDeleteBtn) {
        confirmDeleteBtn.addEventListener("click", async () => {
            try {
                const res = await fetch(`/jobs/${jobId}/clips/${clipId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');
                window.location.href = `/app/jobs/${jobId}/clips`;
            } catch (e) {
                alert('Failed to delete clip: ' + e.message);
                if (deleteModal) deleteModal.classList.add('hidden');
            }
        });
    }

    if (cancelDeleteBtn && deleteModal) {
        cancelDeleteBtn.addEventListener("click", () => {
            deleteModal.classList.add('hidden');
        });
    }

    if (deleteModal) {
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.add('hidden');
            }
        });
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' && deleteClipBtn) {
            deleteClipBtn.click();
        }

        if (e.key === 'Escape' && deleteModal && !deleteModal.classList.contains('hidden')) {
            if (cancelDeleteBtn) cancelDeleteBtn.click();
        }
    });

    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return "00:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60);
        return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function formatDuration(seconds) {
        return formatTime(seconds);
    }

    init();
</script>
{% endblock %}