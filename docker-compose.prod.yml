services:
    # web: Main FastAPI web application (serves API and web frontend)
    web:
        container_name: open_source_clipper_web
        build:
            context: .
            dockerfile: Dockerfile
        # Vast.ai typically uses host networking or specific port mappings.
        # If running via docker-compose inside the instance, map 8000 to the host port you want to expose.
        # Or let Vast.ai handle the mapping if using their on-start script.
        # Here we map 8000:8000, assuming you open port 8000 on Vast.ai dashboard.
        ports:
            - "8000:8000"
        volumes:
            - ./storage:/app/storage
            - ./downloads:/app/downloads
        env_file:
            - .env
        restart: unless-stopped
        depends_on:
            - redis

    # worker: Celery GPU worker for processing GPU-accelerated tasks from the queue
    worker:
        container_name: open_source_clipper_worker
        build:
            context: .
            dockerfile: Dockerfile
        # We use the generic 'celery' queue unless you have specific routing set up.
        # If you separated queues in app code, adjust accordingly.
        # Based on celery_app.py, default queue is 'celery'.
        command: celery -A app.celery_app worker -l info -c 1
        volumes:
            - ./storage:/app/storage
            - ./downloads:/app/downloads
        env_file:
            - .env
        restart: unless-stopped
        deploy:
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          count: 1
                          capabilities: [gpu]
        depends_on:
            - redis

    # beat: Celery Beat scheduler for scheduled/background tasks
    beat:
        container_name: open_source_clipper_beat
        build:
            context: .
            dockerfile: Dockerfile
        command: celery -A app.celery_app beat -l info
        volumes:
            - ./storage:/app/storage
            - ./downloads:/app/downloads
        env_file:
            - .env
        restart: unless-stopped
        depends_on:
            - redis

    # redis: Redis message broker for Celery and backend
    redis:
        container_name: open_source_clipper_redis
        image: "redis:7-alpine"
        restart: unless-stopped
        volumes:
            - redis_data:/data
        ports:
            - "6379:6379"

volumes:
    redis_data:
